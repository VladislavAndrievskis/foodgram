# Редирект с HTTP на HTTPS
server {
 listen 80;
 server_name andrievskis.sytes.net 89.169.181.37;

 return 301 https://$host$request_uri;
}

# Основной сервер — HTTPS
server {
 listen 443 ssl;
 server_name andrievskis.sytes.net;

 ssl_certificate /etc/letsencrypt/live/andrievskis.sytes.net/fullchain.pem;
 ssl_certificate_key /etc/letsencrypt/live/andrievskis.sytes.net/privkey.pem;
 ssl_protocols TLSv1.2 TLSv1.3;
 ssl_ciphers HIGH:!aNULL:!MD5;
 ssl_prefer_server_ciphers on;
 ssl_session_cache shared:SSL:10m;
 ssl_session_timeout 10m;

 client_max_body_size 10m;

 # Сначала — статика фронтенда (React/Vue)
 location /static/ {
 alias /usr/share/nginx/html/static/;
 expires 1d;
 add_header Cache-Control "public, no-transform";
 }

# Потом — статика Django (чтобы не перекрывалась)
 location /django-static/ {
 alias /app/static/;
 expires 1d;
 add_header Cache-Control "public, no-transform";
 }

# Медиафайлы
 location /media/ {
 alias /app/media/;
 expires 1d;
 add_header Cache-Control "public, no-transform";
 }

# API
 location /api/ {
 proxy_pass http://backend:8000/api/;
 proxy_set_header Host $host;
 proxy_set_header X-Real-IP $remote_addr;
 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 proxy_set_header X-Forwarded-Proto $scheme;
 }

 location /admin/ {
 proxy_pass http://backend:8000/admin/;
 proxy_set_header Host $host;
 proxy_set_header X-Real-IP $remote_addr;
 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 proxy_set_header X-Forwarded-Proto https;
 proxy_set_header Referer $http_referer;
 }

 location / {
 root /usr/share/nginx/html;
 try_files $uri $uri/ /index.html;
 }

 error_page 500 502 503 504 /50x.html;
 location = /50x.html {
 root /app;
 }
}